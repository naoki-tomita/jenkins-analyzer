<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.css"/>
</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.js"></script>
  <div id="chart"></div>
  <script>
    async function main() {
      const result = await fetch("/list");
      const all = await result.json();
      const json = all.filter(it => it.status === "SUCCESS").slice(-200) // StatusがSUCCESSの直近200件のジョブを絞りこむ
      const allKeys = [...new Set(json.map(it => it.stages.map(it => it.name)).flat())] // ステージ名を取り出す。これがチャートの線一本一本になる
        .filter(it => it !== "check deploy for production"); // 特殊なステージなので除外している
      const columns = allKeys.map(key => [key, ...json.map(it => it.stages.find(it => it.name === key)?.durationMillis / (1000 * 60) ?? null)]) // ステージごとの実行時間を取り出している。ついでにここで分単位に計算し直している。
        .filter(column => Math.max(...column.slice(1)) > 0.5); // 0.5分(30秒)より短いジョブはここで除外している(うざかったので)。
      const x = json.map(it => it.name); // X軸に表示する #123 とかの情報を作る
      const keys = columns.map(it => it[0]); // 最終的に表示する線の表示名を作っている
      const types = keys.reduce((prev, curr) => ({ ...prev, [curr]: "area" }), {}); // 積み上げグラフの設定

      console.log(types, keys, columns);

      const chart = c3.generate({
        bindto: "#chart",
        size: { height: 680 },
        data: {
          columns,
          groups: [keys],
          types,
        },
        axis: {
          x: {
            type: "category",
            categories: x,
            tick: {
              culling: {
                max: 20,
              },
            },
          },
          y: { min: 0 }
        },
        subchart: {
          show: true
        }
      });
    }
    main();
  </script>
</body>
</html>
